{% extends 'base.html' %}

{% block content %}
<!-- =================== NAVBAR =================== -->
{% include 'includes/navbar.html' %}

<section class="section-content padding-y">

    <div class="card mx-auto" style="max-width:720px; margin-top:40px;">
        <article class="card-body">
            {% include 'includes/alerts.html' %}
            <header class="mb-4">
                <h4 class="card-title">Editar Perfil</h4>
            </header>

            <form id="perfil-form" action="{% url 'editar_perfil' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Erros gerais -->
                {% if usuario_form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in usuario_form.non_field_errors %}{{ error }}<br>{% endfor %}
                    </div>
                {% endif %}
                {% if perfil_form.non_field_errors %}s
                    <div class="alert alert-danger">
                        {% for error in perfil_form.non_field_errors %}{{ error }}<br>{% endfor %}
                    </div>
                {% endif %}

                <!-- Foto de perfil -->
                <div class="text-center mb-4">
                    {% if perfilusuario.foto_perfil %}
                        <img src="{{ perfilusuario.foto_perfil.url }}" alt="Foto de Perfil" width="120" style="border-radius:50px;">
                    {% else %}
                        {% load static %}
                        <img src="{% static 'images/default.png' %}" alt="Sem foto" width="120" style="border-radius:50px;">
                    {% endif %}
                </div>

                <!-- Nome e Sobrenome -->
                <div class="form-row">
                    <div class="col form-group">
                        <label>Nome</label>
                        {{ usuario_form.nome }}
                        {% if usuario_form.nome.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in usuario_form.nome.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col form-group">
                        <label>Sobrenome</label>
                        {{ usuario_form.sobrenome }}
                        {% if usuario_form.sobrenome.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in usuario_form.sobrenome.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Telefone e CPF -->
                <div class="form-row">
                    <div class="col form-group">
                        <label>Telefone</label>
                        {{ usuario_form.numero_telefone }}
                        {% if usuario_form.numero_telefone.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in usuario_form.numero_telefone.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col form-group">
                        <label>CPF</label>
                        {{ usuario_form.cpf }}
                        {% if usuario_form.cpf.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in usuario_form.cpf.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Foto de perfil -->
                <div class="form-group">
                    <label>Foto de Perfil</label>
                    {{ perfil_form.foto_perfil }}
                    {% if perfil_form.foto_perfil.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in perfil_form.foto_perfil.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Endereço -->
                <div class="form-row">
                    <div class="col form-group">
                        <label>Estado</label>
                        {{ perfil_form.estado }}
                        {% if perfil_form.estado.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in perfil_form.estado.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col form-group">
                        <label>Cidade</label>
                        {{ perfil_form.cidade }}
                        {% if perfil_form.cidade.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in perfil_form.cidade.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="col form-group">
                        <label>CEP</label>
                        {{ perfil_form.cep }}
                        {% if perfil_form.cep.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in perfil_form.cep.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col form-group">
                        <label>Bairro</label>
                        {{ perfil_form.bairro }}
                        {% if perfil_form.bairro.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in perfil_form.bairro.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="col form-group">
                        <label>Endereço</label>
                        {{ perfil_form.endereço }}
                        {% if perfil_form.endereço.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in perfil_form.endereço.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col form-group">
                        <label>Número</label>
                        {{ perfil_form.número }}
                        {% if perfil_form.número.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in perfil_form.número.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Salvar</button>
            </form>
        </article>
    </div>

</section>

<!-- MÁSCARAS PARA CPF, TELEFONE E CEP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
$(document).ready(function(){
    $('input[name="cpf"]').mask('000.000.000-00');
    $('input[name="numero_telefone"]').mask('(00) 00000-0000');
    $('input[name="cep"]').mask('00000-000');

    $('#perfil-form').on('submit', function(){
        let telefone = $('input[name="numero_telefone"]').val().replace(/\D/g,'');
        let cep = $('input[name="cep"]').val().replace(/\D/g,'');
        if(telefone.length < 10 || telefone.length > 11){
            alert("Telefone inválido!");
            return false;
        }
        if(cep.length != 8){
            alert("CEP inválido!");
            return false;
        }
    });
});
</script>

{% endblock %}
