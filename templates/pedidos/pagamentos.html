{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="section-content padding-y bg">
<div class="container">

<!-- ============================ COMPONENT 1 ================================= -->

<h4 class="text-center mb-10">Revisar seu Pedido e Fazer o Pagamento</h4>
<div class="row">	
	<aside class="col-lg-8">
		<div class="card">
			<h5 class="card-header">Endereço de Entrega</h5>
			<div class="card-body">
				<p class="card-text mb-0">{{pedido.nome_completo}}</p>
				<p class="card-text mb-0">{{pedido.cidade}}, {{pedido.estado}}</p>
				<p class="card-text mb-0">{{pedido.bairro}}, {{pedido.cep}}</p>
				<p class="card-text mb-0">{{pedido.endereço_completo}}</p>
				<p class="card-text mb-0">{{pedido.email}}</p>
				<p class="card-text mb-0">{{pedido.telefone}}</p>		
				{% if pedido.nota_pedido %}
				<b>Nota do Pedido: </b> {{pedido.nota_pedido}}
				{% endif %}

			</div>
		</div>
		<div class="card">
			<h5 class="card-header">Método de Pagamento</h5>
			<div class="card-body">
				<p class="card-text">PayPal</p>
			</div>
		</div>
		<div class="card">
			<h5 class="card-header">Revisar Produtos</h5>
			<div class="card-body">
				<table class="table table-borderless table-shopping-cart">
<thead class="text-muted">
<tr class="small text-uppercase">
  <th scope="col">Produto</th>
  <th scope="col" width="120">Quantidade</th>
  <th scope="col" width="120">Preço</th>
</tr>
</thead>
<tbody>

{% for carrinho_item in carrinho_itens %}
<tr>
	<td>
		<figure class="itemside align-items-center">
			<div class="aside"><img src="{{ carrinho_item.produto.imagens.url }}" class="img-sm"></div>
			<figcaption class="info">
				<a href="{{ carrinho_item.produto.get_url }}" class="title text-dark">{{ carrinho_item.produto.nome_produto }}</a>
				<p class="text-muted small">
					{% if carrinho_item.variações.all %}
						{% for item in carrinho_item.variações.all %}
							{{ item.variação_categoria | capfirst }} : {{ item.valor_variação | capfirst }} <br>
						{% endfor %}
					{% endif %}
			</figcaption>
		</figure>
	</td>
	<td> 
		<!-- col.// -->
         <label for="">{{carrinho_item.quantidade}}</label>			
	</td>
	<td> 
		<div class="price-wrap"> 
			<var class="price">R$ {{ carrinho_item.sub_total }}</var> 
			<small class="text-muted"> {{ carrinho_item.produto.preço }} cada </small> 
		</div> <!-- price-wrap .// -->
	</td>	
</tr>
{% endfor %}

</tbody>
</table>
			</div>
		</div>
 <!-- card.// -->

	</aside> <!-- col.// -->
	<aside class="col-lg-4">

		<div class="card">
		<div class="card-body">
			
			</dl>
			<dl class="dlist-align">
			  <dt>Valor Total:</dt>
			  <dd class="text-right text-dark b"><strong>R$ {{total}}</strong></dd>
			</dl>
			<hr>
			<p class="text-center mb-3">
				<img src="{% static './images/misc/payments.png' %}" height="26">
			</p>
			
			<div id="paypal-button-container">
				<!--botão PayPal-->
			</div>
		</div> <!-- card-body.// -->
		</div> <!-- card.// -->

</aside> <!-- col.// -->


</div> <!-- row.// -->
<!-- ============================ COMPONENT 1 END .// ================================= -->

</div> <!-- container .//  -->
</section>
<!-- ========================= SECTION CONTENT END// ========================= -->

<script>

	function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
			}
		}
	}
    return cookieValue;
}

	var amount = parseFloat("{{ total }}");
	var url = "{% url 'pagamentos' %}";
	var csrftoken = getCookie('csrftoken');
	var pedidoID = "{{ pedido.número_pedido }}";
	var payment_method = 'PayPal'
	var redirect_url = "{% url 'pedido_completo' %}"

    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: amount,
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                console.log(details);
				sendData();
				function sendData(){
					fetch(url, {
						method: 'POST',
						headers: {
							"Content-Type": "application/json",
							"X-CSRFToken": csrftoken,
						},
						body: JSON.stringify({
							orderID: pedidoID,
							transID: details.id,
							payment_method: payment_method,
							status: details.status,
						})
					})
					.then((response) => response.json())
					.then((data) => {
						window.location.href = redirect_url + '?número_pedido='+data.número_pedido+'&pagamento_id='+data.transID;
					});
				}
            });
        }
    }).render('#paypal-button-container');
</script>

{% endblock %}